---
title: "Combine broad river types and Illies Freshwater Ecoregions"
author: "Jonathan Jupke"
bibliography: ../doc/parts/ref.bib
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(sf, magrittr,dplyr,tmap, stringr, ggplot2, data.table)
data   <- readRDS("E://Arbeit/Data/broad_river_types/with_illies/brt_with_illies.rds")
illies <- st_read("E://Arbeit/Data/Illies_freshwater_ecoregions/Ecoregions.shp")
geo  <- st_read("E://Arbeit/Data/IHME1500_v11/ihme_1500_litho4changed.shp")
fec  <- st_read("E://Arbeit/Data/ecrins/EcrFEC.sqlite")
source("new_typology/auxilliary/geology_vector.R")
source("../../../../../my documents/R/progress_bar.R")
```


```{r options, include=FALSE}
tmap_mode("view")
```

```{r prepare spatial data}
data %<>% st_transform(crs = st_crs(fec))
geo  %<>% st_transform(crs = st_crs(fec))

st_agr(data) <- "constant"
st_agr(geo)  <- "constant"
```



```{r echo = F}
#- remove entries with NA Illies 
data <- data[!grepl(x = data$brt12_illies, pattern = "NA$"),]
data <- data[!grepl(x = data$brt12_illies, pattern = "^NA"),]
data %<>% 
        mutate(m_btype12 = factor(m_btype12, levels = paste0("RT",1:12))) %>%
        arrange(m_btype12)
backup <- data
```


## Intro 
First I need to define what a rare type is. How often do the types occur? 
```{r}
data |> 
        pull(brt12_illies) |> 
        table() |> 
        c() |> 
        summary()
```
The first quartile is 212 reaches. 

I first identify rare types (<200 occurrences) and identify the types they optimally should be grouped with. I usually combined types within not across ecoregions. 

I keep the rare RT1-based types, as very large rivers are quite distinct [e.g. @borgwardt2019ex].   
In the following I address the rare types ordered by ecoregions. 
## Alps 
```{r ALPS INSPECT, echo = FALSE}
data |> 
        filter(m_btype12 != "RT1") |>
        filter(NAME == "Alps") |> 
        pull(brt12_illies) |> 
        table() |> 
        sort()
```
```{r ALPS MAP, echo = FALSE}
#tm_shape(data[which(data$NAME == "Alps"), ]) + tm_lines(col = "brt12_illies", scale = 2)
```
The two siliceous lowland types RT4 and RT5 are rare in the Alps. I group them with the respective mid altitude types. 

```{r echo = FALSE }
data$brt12_illies[which(data$brt12_illies == "RT4_Alps")] <- "RT8_Alps"
data$brt12_illies[which(data$brt12_illies == "RT5_Alps")] <- "RT9_Alps"
```

## Baltic province 

```{r echo=F}
data |> 
        filter(m_btype12 != "RT1") |>
        filter(NAME == "Baltic province") |> 
        pull(brt12_illies) |> 
        table() 
```
```{r BALTIC MAP, echo = FALSE}
# temp <- data[which(data$NAME == "Baltic province"), ]
# tm_shape(temp) + tm_lines(col = "brt12_illies", scale = 2)
```


As we are only dealing with two segments, so I remove them from the data. 
There are very few mid-altitude rivers in the baltic ecoregion. 
The two mid-altitude types types **RT6** and **RT9** are combined with they respective lowland types (RT2 and RT5)

```{r echo = FALSE }
data$brt12_illies[which(data$brt12_illies == "RT6_Baltic province")] <- "RT2_Baltic province"
data$brt12_illies[which(data$brt12_illies == "RT9_Baltic province")] <- "RT5_Baltic province"
```

It is very surprising to find rivers of the type **RT12** *Mediterranean temporary and very small* so far in the north. 
I assume that this is an erroneous assignment. 

```{r, echo = F}
data <- filter(data, brt12_illies != "RT12_Baltic province")
```

## Borealic uplands
```{r echo=F}
data |> 
        filter(m_btype12 != "RT1") |>
        filter(NAME == "Borealic uplands") |> 
        pull(brt12_illies) |> 
        table() |> 
        sort()
```

There are four rare types here: RT2, RT3, RT6 and RT7 - calcareous streams of all sizes and altitudes. 
Both rare types (RT2 and 6) are calcareous medium-large types. It would be a possibility to combine them into one. Given the low prevalence of each type, the combined type would still be rare. Hence, I  join them with the respective siliceous types. 

```{r, echo=F}
data$brt12_illies[which(data$brt12_illies == "RT2_Borealic uplands")] <- "RT4_Borealic uplands"
data$brt12_illies[which(data$brt12_illies == "RT3_Borealic uplands")] <- "RT5_Borealic uplands"
data$brt12_illies[which(data$brt12_illies == "RT6_Borealic uplands")] <- "RT8_Borealic uplands"
data$brt12_illies[which(data$brt12_illies == "RT7_Borealic uplands")] <- "RT9_Borealic uplands"
```
## The Carpathiens
```{r echo=F}
data |> 
        filter(m_btype12 != "RT1") |>
        filter(NAME == "The Carpathiens") |> 
        pull(brt12_illies) |> 
        table() |> 
        sort()
```
There are three rare types in the Carpathians: RT3,4 and 5 - both siliceous lowland rivers and the small calcareous ones. 
In this case I combine the rivers into lowland Carpathians

```{r, echo=F}
data$brt12_illies[which(data$brt12_illies == "RT4_The Carpathiens")] <- "lowland_The Carpathiens"
data$brt12_illies[which(data$brt12_illies == "RT5_The Carpathiens")] <- "lowland_The Carpathiens"
data$brt12_illies[which(data$brt12_illies == "RT3_The Carpathiens")] <- "lowland_The Carpathiens"
data$brt12_illies[which(data$brt12_illies == "RT2_The Carpathiens")] <- "lowland_The Carpathiens"
```


## The Caucasus 

```{r echo=F}
data |> 
        filter(m_btype12 != "RT1") |>
        filter(NAME == "The Caucasus") |> 
        pull(brt12_illies) |> 
        table() |> 
        sort()
```

```{r MAP CAUCASUS, echo = F}
temp <- data[which(data$NAME == "The Caucasus"), ]
tm_shape(temp) + tm_lines(col = "brt12_illies", scale = 2)
```

Only a few stream segments at the very edge of our data fall within this ecoregion. I remove it from the data set. 

```{r, echo=F}
data %<>% filter(NAME != "The Caucasus")
```
## Central highlands

```{r echo=F}
data |> 
        filter(m_btype12 != "RT1") |>
        filter(NAME == "Central highlands") |> 
        pull(brt12_illies) |> 
        table() |> 
        sort()
```

No rare types. 


## Central plains
```{r echo=F}
data |> 
        filter(m_btype12 != "RT1") |>
        filter(NAME == "Central plains") |> 
        pull(brt12_illies) |> 
        table() |> 
        sort()
```
No rare types. 
## Dinaric western Balkan
```{r echo=F}
data |> 
        filter(m_btype12 != "RT1") |>
        filter(NAME == "Dinaric western Balkan") |> 
        pull(brt12_illies) |> 
        table() |> 
        sort()
```

No rare types. 

## Eastern Balkan
```{r}
data |> 
        filter(m_btype12 != "RT1") |>
        filter(NAME == "Eastern Balkan") |> 
        pull(brt12_illies) |> 
        table() |> 
        sort()
```

RT3 is rare and joined with RT6. 
```{r echo = FALSE}
data$brt12_illies[which(data$brt12_illies == "RT3_Eastern Balkan")] <- "RT6_Eastern Balkan"
```

## Eastern plains
```{r}
data |> 
        filter(m_btype12 != "RT1") |>
        filter(NAME == "Eastern plains") |> 
        pull(brt12_illies) |> 
        table() |> 
        sort()
```

RT8 is rare and joined with the respective lowland type.

```{r}
data$brt12_illies[which(data$brt12_illies == "RT8_Eastern Balkan")] <- "RT4_Eastern Balkan"
```


## England
```{r}
data |> 
        filter(m_btype12 != "RT1") |>
        filter(NAME == "England") |> 
        pull(brt12_illies) |> 
        table() |> 
        sort()
```

The two mid-altitude calcareous types are joined with the lowland types. 

```{r}
data$brt12_illies[which(data$brt12_illies == "RT6_England")] <- "RT2_England"
data$brt12_illies[which(data$brt12_illies == "RT7_England")] <- "RT3_England"
```


## Fenno-scandian shield
```{r}
data |> 
        filter(m_btype12 != "RT1") |>
        filter(NAME == "Fenno-scandian shield") |> 
        pull(brt12_illies) |> 
        table() |> 
        sort()
```

RT 2,3, 6 and 7 all calcareous types are rare. Too rare to from a special type. So they are joined to the corresponding siliceous types. 
```{r echo = F}
data$brt12_illies[which(data$brt12_illies == "RT2_Fenno-scandian shield")] <- "RT4_Fenno-scandian shield"
data$brt12_illies[which(data$brt12_illies == "RT3_Fenno-scandian shield")] <- "RT5_Fenno-scandian shield"
data$brt12_illies[which(data$brt12_illies == "RT6_Fenno-scandian shield")] <- "RT8_Fenno-scandian shield"
data$brt12_illies[which(data$brt12_illies == "RT7_Fenno-scandian shield")] <- "RT9_Fenno-scandian shield"
```
## Hellenic western Balkan

```{r}
data |> 
        filter(m_btype12 != "RT1") |>
        filter(NAME == "Hellenic western Balkan") |> 
        pull(brt12_illies) |> 
        table() |> 
        sort()
```

In this ecoregion small lowland rivers are rare because they are mostly temporary and thus fall under RT12. 
I combine all lowland types with their mid-altitude types. 
```{r echo = F}
data$brt12_illies[which(data$brt12_illies == "RT3_Hellenic western Balkan")] <- "RT6_Hellenic western Balkan"
data$brt12_illies[which(data$brt12_illies == "RT4_Hellenic western Balkan")] <- "RT7_Hellenic western Balkan"
data$brt12_illies[which(data$brt12_illies == "RT5_Hellenic western Balkan")] <- "RT8_Hellenic western Balkan"
```

## Hungarian lowlands  
```{r echo=F}
data |> 
        filter(m_btype12 != "RT1") |>
        filter(NAME == "Hungarian lowlands") |> 
        pull(brt12_illies) |> 
        table() |> 
        sort()
```

Nothing rare. 

## Ibero-Macaronesian region
```{r echo=F}
data |> 
        filter(m_btype12 != "RT1") |>
        filter(NAME == "Ibero-Macaronesian region") |> 
        pull(brt12_illies) |> 
        table() |> 
        sort()
```

```{r echo = F}
data$brt12_illies[which(data$brt12_illies == "RT6_Ibero-Macaronesian region")] <- "RT7_Hellenic western Balkan"
```

## Iceland                     
```{r echo=F}
data |> 
        filter(m_btype12 != "RT1") |>
        filter(NAME == "Iceland") |> 
        pull(brt12_illies) |> 
        table() |> 
        sort()
```

## Ireland and Northern Ireland
```{r echo=F}
data |> 
        filter(m_btype12 != "RT1") |>
        filter(NAME == "Ireland and Northern Ireland") |> 
        pull(brt12_illies) |> 
        table() |> 
        sort()
```
Here we find the opposite situation to the Pyrenees and the Baltic province: RT7/8 are rare and RT 6/9 more common. The approach, however, remains the same. We combine the mid-altitude streams to one type per bedrock, irrespective of size. 

```{r, echo=F}
# temp <- data[which(data$NAME == "Ireland and Northern Ireland"), ]
# tm_shape(temp) + tm_lines(col = "brt12_illies", scale = 2)
data %<>% mutate(brt12_illies = ifelse(brt12_illies == "RT6_Ireland and Northern Ireland" | brt12_illies == "RT7_Ireland and Northern Ireland", "RT6/7_Ireland and Northern Ireland", brt12_illies))
data %<>% mutate(brt12_illies = ifelse(brt12_illies == "RT9_Ireland and Northern Ireland" | brt12_illies == "RT8_Ireland and Northern Ireland", "RT8/9_Ireland and Northern Ireland", brt12_illies))
```



## Italy and Corsica
```{r echo=F}
data |> 
        filter(m_btype12 != "RT1") |>
        filter(NAME == "Dinaric western Balkan") |> 
        pull(brt12_illies) |> 
        table() |> 
        sort()
```
## Pontic province            
```{r echo=F}
data |> 
        filter(m_btype12 != "RT1") |>
        filter(NAME == "Dinaric western Balkan") |> 
        pull(brt12_illies) |> 
        table() |> 
        sort()
```           

            
## Western highlands     
```{r echo=F}
data |> 
        filter(m_btype12 != "RT1") |>
        filter(NAME == "Dinaric western Balkan") |> 
        pull(brt12_illies) |> 
        table() |> 
        sort()
```
## Western plains    
```{r echo=F}
data |> 
        filter(m_btype12 != "RT1") |>
        filter(NAME == "Dinaric western Balkan") |> 
        pull(brt12_illies) |> 
        table() |> 
        sort()
```
## Pyrenees   
As with the Baltic province, RT6 and RT9 are combined with RT7 and RT8. 

```{r, echo=F}
temp <- data[which(data$NAME == "Pyrenees"), ]
tm_shape(temp) + tm_lines(col = "brt12_illies", scale = 2)
data %<>% mutate(brt12_illies = ifelse(brt12_illies == "RT6_Pyrenees" | brt12_illies == "RT7_Pyrenees", "RT6/7_Pyrenees", brt12_illies))
data %<>% mutate(brt12_illies = ifelse(brt12_illies == "RT9_Pyrenees" | brt12_illies == "RT8_Pyrenees", "RT8/9_Pyrenees", brt12_illies))
```

## Taiga    

The only instance of the RT9 type (mid-altitude siliceous very small small) drains in to RT5 (lowland siliceous very small small). We will hence consider them as one type. 

```{r, echo=F}
temp <- data[which(data$NAME == "Taiga"), ]
tm_shape(temp) + tm_lines(col = "brt12_illies", scale = 2)
```

## Tundra 
The area covered by BRT and the Illies region "Tundra" is small. 
I add them to the borealic Uplands 

```{r, echo=F}
temp <- data[which(data$NAME == "Tundra"), ]
tm_shape(temp) + tm_lines(col = "brt12_illies", scale = 2)
#tm_shape(illies) + tm_polygons(alpha = .5)
data %<>% mutate(brt12_illies = str_replace(brt12_illies, "Tundra", "Borealic uplands"))
```


 

```{r, echo=F}
# temp <- data[which(data$NAME == "Hellenic western Balkan"), ]
# tm_shape(temp) + tm_lines(col = "brt12_illies", scale = 2)
```


```{r echo = FALSE}
# data <- filter(data, brt12_illies != "RT12_Baltic province")
# data %<>% mutate(brt12_illies = ifelse(brt12_illies == "RT6_Baltic province" | brt12_illies == "RT7_Baltic province", "RT6/7_Baltic province", brt12_illies))
# data %<>% mutate(brt12_illies = ifelse(brt12_illies == "RT9_Baltic province" | brt12_illies == "RT8_Baltic province", "RT8/9_Baltic province", brt12_illies))
# data %<>% filter(NAME != "The Caucasus")
# data %<>% mutate(brt12_illies = ifelse(brt12_illies == "RT2_Borealic uplands" | brt12_illies == "RT3_Borealic uplands", "RT2/3_Borealic uplands", brt12_illies))
# data %<>% mutate(brt12_illies = ifelse(brt12_illies == "RT6_Borealic uplands" | brt12_illies == "RT7_Borealic uplands", "RT6/7_Borealic uplands", brt12_illies))
# data %<>% mutate(brt12_illies = ifelse(brt12_illies == "RT6_Pyrenees" | brt12_illies == "RT7_Pyrenees", "RT6/7_Pyrenees", brt12_illies))
# data %<>% mutate(brt12_illies = ifelse(brt12_illies == "RT9_Pyrenees" | brt12_illies == "RT8_Pyrenees", "RT8/9_Pyrenees", brt12_illies))
# data %<>% mutate(brt12_illies = ifelse(brt12_illies == "RT9_Taiga", "RT5_Taiga", brt12_illies))
# data %<>% mutate(brt12_illies = str_replace(brt12_illies, "Tundra", "Borealic uplands"))
# data %<>% mutate(brt12_illies = ifelse(brt12_illies == "RT6_Ireland and Northern Ireland" | brt12_illies == "RT7_Ireland and Northern Ireland", "RT6/7_Ireland and Northern Ireland", brt12_illies))
# data %<>% mutate(brt12_illies = ifelse(brt12_illies == "RT9_Ireland and Northern Ireland" | brt12_illies == "RT8_Ireland and Northern Ireland", "RT8/9_Ireland and Northern Ireland", brt12_illies))
# data %<>% mutate(brt12_illies = ifelse(brt12_illies == "RT3_Hellenic western Balkan" | brt12_illies == "RT5_Hellenic western Balkan", "RT3/5_Hellenic western Balkan", brt12_illies))
```



# System 
```{r, echo=FALSE}
sessionInfo()
```

# References
```{r, echo = FALSE}
#saveRDS(data, "E://Arbeit/Data/broad_river_types/with_illies/pruned_typology.rds")
```

