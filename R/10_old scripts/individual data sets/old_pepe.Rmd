---
title: 'Individual Data Sets: Pepe Barquin'
author: "Jonathan Jupke"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
pacman::p_load(
        ade4,
        cluster,
        data.table,
        dplyr,
        ggplot2,
        indicspecies,
        magrittr,
        sf,
        tidyr,
        tmap,
        vegan
)
source("../helper_functions.R")
tmap_mode("view")
```

```{r set options}
#- What to load and what to compute
#- TRUE means load
options <- list(
  pre =      FALSE,
  distance = FALSE,
  mantel   = TRUE,
  iv       = TRUE,
  anosim   = TRUE,
  typical  = TRUE
)
```

```{r create global variables}
data.set = "pepe_barquin"
all_seasons <- c("spring", "summer", "autumn", "winter")
seasons <- 2
typologies <- c("brt12")
```

```{r pre}
if (!options$pre){
  most.recent.data <-
    fs::dir_ls("../../data/combined_data/", regexp = "_core_taxa_data.rds") |>
    stringr::str_remove("../../data/combined_data/03_") |>
    stringr::str_remove("_core_taxa_data.rds") |>
    lubridate::ymd() |>
    {
      \(x) x[which.max(x)]
    }()
  
  data <-
    readRDS(file = paste0(
      "../../data/combined_data/03_",
      most.recent.data,
      "_core_taxa_data.rds"
    ))
  da <-
    lapply(data, function(x)
      x[data.set %in% c("Cantabria", "Picos de Europa")])
  #- create subset of least impacted sites
  li <-
    lapply(seasons, function(x)
      da[[x]][fec.least.impacted == TRUE])
  #- create subset of sites that are least impacted and removed from regional borders
  pu <-
    lapply(seq_along(li), function(x)
      li[[x]][illies_distance >= 25000 & bgr_distance >= 25000])
  
  #- remove seasons with few samples 
  da[["spring"]] = NULL
  da[["autumn"]] = NULL

  
  map <- rbindlist(da)
  map %<>% unique(by = "gr_sample_id")
  map %<>% st_as_sf()
  tm_shape(map) + tm_dots() + tm_facets(by = "season")
  
  #- check how many instances of each type are there 
  sapply(1, function(x)
    uniqueN(pu[[x]]$bgr))
  sapply(1, function(x)
    uniqueN(pu[[x]]$illies))
  sapply(1, function(x)
    uniqueN(pu[[x]]$brt12))
          
          
    das2 <-
      prep1(data = da,
            taxon = "species")
    lis2 <- prep1(data = li,
                  taxon = "species")
  pus2 <- prep1(data = pu,
                taxon = "species")
  dag2 <- prep1(data = da,
                taxon = "genus")
  lig2 <- prep1(data = li,
                taxon = "genus")
  pug2 <- prep1(data = pu,
                taxon = "genus")
  daf2 <- prep1(data = da,
                taxon = "family")
  lif2 <- prep1(data = li,
                taxon = "family")
  puf2 <- prep1(data = pu,
                taxon = "family")
  # --- abundance --- #
  das2_abu <- 
        prep1(
      data = da,
      taxon = "species",
      abundance.to.pa = FALSE
    )
  dag2_abu <- 
        prep1(
      data = da,
      taxon = "genus",
      abundance.to.pa = FALSE
    )
  daf2_abu <- 
        prep1(
      data = da,
      taxon = "family",
      abundance.to.pa = FALSE
    )
  
  das3 <- prep2(das2)
  lis3 <- prep2(lis2)
  pus3 <- prep2(pus2)
  dag3 <- prep2(dag2)
  lig3 <- prep2(lig2)
  pug3 <- prep2(pug2)
  daf3 <- prep2(daf2)
  lif3 <- prep2(lif2)
  puf3 <- prep2(puf2)
  
  #--- abundance -- # 
  das3_abu <- prep2(das2_abu)
  dag3_abu <- prep2(dag2_abu)
  daf3_abu <- prep2(daf2_abu)
  
  saveRDS(
    object = list(das2 = das2,
                  das3 = das3, 
                  lis2 = lis2, 
                  lis3 = lis3, 
                  pus2 = pus2,
                  pus3 = pus3, 
                  dag2 = dag2,
                  dag3 = dag3,
                  lig2 = lig2,
                  lig3 = lig3,
                  pug2 = pug2,
                  pug3 = pug3,
                  daf2 = daf2,
                  daf3 = daf3,
                  lif2 = lif2,
                  lif3 = lif3,
                  puf2 = puf2,
                  puf3 = puf3,
                  das2_abu = das2_abu, 
                  das3_abu = das3_abu,
                  dag2_abu = dag2_abu, 
                  dag3_abu = dag3_abu,
                  daf2_abu = daf2_abu, 
                  daf3_abu = daf3_abu
                  ), 
    file = paste0("auxilliary/pre_",data.set,".rds")
  )
} else if (options$pre){
  pre = readRDS(file = paste0("auxilliary/pre_",data.set,".rds"))
  for (i in seq_along(pre)){
    assign(x     = names(pre)[i], 
           value = pre[[i]])
  }
}
```

```{r distance_matrices}
# DISTANCE MATRIX  ------------------------------------------------------------------
if (!options$distance) {
  
  das.dist <- das3     |> prep3()
  lis.dist <- lis3     |> prep3()
  pus.dist <- pus3     |> prep3()
  dag.dist <- dag3     |> prep3()
  lig.dist <- lig3     |> prep3()
  pug.dist <- pug3     |> prep3()
  daf.dist <- daf3     |> prep3()
  lif.dist <- lif3     |> prep3()
  puf.dist <- puf3     |> prep3() 
  das.abu.dist <- das3_abu |> prep3()
  dag.abu.dist <- dag3_abu |> prep3()
  daf.abu.dist <- daf3_abu |> prep3()

  saveRDS(
    object = list(

      das.dist = das.dist ,
      lis.dist = lis.dist ,
      pus.dist = pus.dist ,
      dag.dist = dag.dist ,
      lig.dist = lig.dist ,
      pug.dist = pug.dist ,
      daf.dist = daf.dist ,
      lif.dist = lif.dist ,
      puf.dist = puf.dist ,
      das.dist = das.dist ,
      dag.dist = dag.dist ,
      daf.dist = daf.dist , 
      das.abu.dist = das.abu.dist,
      dag.abu.dist = dag.abu.dist, 
      daf.abu.dist = daf.abu.dist 
      
    ),
    file = paste0("auxilliary/distance_", data.set, ".rds")
  )
} else if (options$distance) {
  distance_list = readRDS(file = paste0("auxilliary/distance_", data.set, ".rds"))
  for (i in seq_along(distance_list)) {
    assign(x     = names(distance_list)[i],
           value = distance_list[[i]])
  }
}
```

# Mantel Correlation 

```{r MANTEL TEST }
if (!options$mantel) {
  #- doesnt work
  m1 <- lapply(1, function(x) mantel.rtest(das.dist[[x]], dag.dist[[x]]))
  m2 <- lapply(1, function(x) mantel.rtest(dag.dist[[x]], daf.dist[[x]]))
  m3 <- lapply(1, function(x) mantel.rtest(das.dist[[x]], daf.dist[[x]]))
  m4 <- lapply(1, function(x) mantel.rtest(das.abu.dist[[x]], das.dist[[x]]))
  m5 <- lapply(1, function(x) mantel.rtest(dag.abu.dist[[x]], dag.dist[[x]]))
  m6 <- lapply(1, function(x) mantel.rtest(daf.abu.dist[[x]], daf.dist[[x]]))
  m7 <- lapply(1, function(x) mantel.rtest(das.abu.dist[[x]], dag.abu.dist[[x]]))
  m8 <- lapply(1, function(x) mantel.rtest(dag.abu.dist[[x]], daf.abu.dist[[x]]))
  m9 <- lapply(1, function(x) mantel.rtest(das.abu.dist[[x]], daf.abu.dist[[x]]))
  

  saveRDS(list(
    m1 = m1, 
    m2 = m2, 
    m3 = m3, 
    m4 = m4,
    m5 = m5,
    m6 = m6,
    m7 = m7,
    m8 = m8,
    m9 = m9
    ), 
    paste0("mantel_", data.set, ".rds"))
} else if (options$mantel) {
  mantel.list <- readRDS(paste0("mantel_", data.set, ".rds"))
  for (i in seq_along(mantel.list)) {
    assign(x     = names(mantel.list)[i],
           value = mantel.list[[i]])
  }
}

```

The mantel statistics are: `r round(m1[[1]]$obs,3)` species to genus PA, `r round(m2[[1]]$obs,3)` genus to family PA, `r round(m3[[1]]$obs,3)` species to family PA, `r round(m4[[1]]$obs,3)` PA to abundance species, `r round(m5[[1]]$obs,3)` PA to abundance genus, `r round(m6[[1]]$obs,3)` PA to abundance family, `r round(m7[[1]]$obs,3)` species to genus abundance, `r round(m8[[1]]$obs,3)` genus to family abundance, `r round(m9[[1]]$obs,3)` species to family abundance. 

# Point Biserial Correlation with indicspecies

```{r PBS Correlation}
if (!options$iv){

ivsas <- ivs(data2 = das2, data3 = das3, season.data = 1, typologies = typologies, add = "all observations")
ivsag <- ivs(data2 = dag2, data3 = dag3, season.data = 1, typologies = typologies, add = "all observations")
ivsaf <- ivs(data2 = daf2, data3 = daf3, season.data = 1, typologies = typologies, add = "all observations")
ivsls <- ivs(data2 = lis2, data3 = lis3, season.data = 1, typologies = typologies, add = "least impacted")
ivslg <- ivs(data2 = lig2, data3 = lig3, season.data = 1, typologies = typologies, add = "least impacted")
ivslf <- ivs(data2 = lif2, data3 = lif3, season.data = 1, typologies = typologies, add = "least impacted")
ivsps <- ivs(data2 = pus2, data3 = pus3, season.data = 1, typologies = typologies, add = "purified")
ivspg <- ivs(data2 = pug2, data3 = pug3, season.data = 1, typologies = typologies, add = "purified")
ivspf <- ivs(data2 = puf2, data3 = puf3, season.data = 1, typologies = typologies, add = "purified")

saveRDS(list(ivsas = ivsas,
             ivsag = ivsag,
             ivsaf = ivsaf,
             ivsls = ivsls,
             ivslg = ivslg,
             ivslf = ivslf,
             ivsps = ivsps,
             ivspg = ivspg,
             ivspf = ivspf), 
        file = paste0("auxilliary/iv_",data.set,".rds")
        )

} else if (options$iv){
  iv.list <- readRDS(paste0("auxilliary/iv_",data.set,".rds"))
    for (i in seq_along(iv.list)) {
    assign(x     = names(iv.list)[i],
           value = iv.list[[i]])
  }
}

ivs_species <- rbindlist(list(ivsas, ivsls, ivsps))
ivs_genus   <- rbindlist(list(ivsag, ivslg, ivspg))
ivs_family  <- rbindlist(list(ivsaf, ivslf, ivspf))

ivs_species_mean <- ivs_species[,mean(indval), by = c("typology", "type")]
ivs_genus_mean   <- ivs_species[,mean(indval), by = c("typology", "type")]
ivs_family_mean  <- ivs_species[,mean(indval), by = c("typology", "type")]
ivs_species_mean[,c("taxon.level", "variable") := .("species", "ivs_corr")]
  ivs_genus_mean[,c("taxon.level", "variable") := .("genus"  , "ivs_corr")]
 ivs_family_mean[,c("taxon.level", "variable") := .("family" , "ivs_corr")]
```

```{r echo =F }
ivs.plot1(ivs_species, taxon = "species")
ivs.plot1(ivs_genus, taxon = "genus")
ivs.plot1(ivs_family, taxon = "family")
```

# Classification Strength

```{r COMPUTE CLASSIFICATION STRENGTH}
csas <- class.strength(data2 = das2, data4 = das.dist, season.data = 1, add = "all observations")
csag <- class.strength(data2 = dag2, data4 = dag.dist, season.data = 1, add = "all observations")
csaf <- class.strength(data2 = daf2, data4 = daf.dist, season.data = 1, add = "all observations")
csls <- class.strength(data2 = lis2, data4 = lis.dist, season.data = 1, add = "least impacted")
cslg <- class.strength(data2 = lig2, data4 = lig.dist, season.data = 1, add = "least impacted")
cslf <- class.strength(data2 = lif2, data4 = lif.dist, season.data = 1, add = "least impacted")
csps <- class.strength(data2 = pus2, data4 = pus.dist, season.data = 1, add = "purified")
cspg <- class.strength(data2 = pug2, data4 = pug.dist, season.data = 1, add = "purified")
cspf <- class.strength(data2 = puf2, data4 = puf.dist, season.data = 1, add = "purified")

cs_species <- rbindlist(list(csas, csls, csps))
cs_genus   <- rbindlist(list(csag, cslg, cspg))
cs_family  <- rbindlist(list(csaf, cslf, cspf))

cs_species_mean <- cs_species[,mean(cs), by = c("typology", "type")]
cs_genus_mean   <- cs_genus[,mean(cs), by = c("typology", "type")]
cs_family_mean  <- cs_family[,mean(cs), by = c("typology", "type")]
cs_species_mean[,c("taxon.level", "variable") := .("species", "cs")]
cs_genus_mean[,c("taxon.level", "variable") := .("genus"  , "cs")]
cs_family_mean[,c("taxon.level", "variable") := .("family" , "cs")]

```

```{r}
class.strength.plot1(cs_species, taxon = "species")
class.strength.plot1(cs_genus, taxon = "genus")
class.strength.plot1(cs_family, taxon = "family")
```

# Silhouette Width 

```{r}
seasons = 1
sias <- wraper_silhouette(data2 = das2, distance = das.dist, add = "all observations")
sias <- wraper_silhouette(data2 = das2, distance = das.dist, add = "all observations")
siag <- wraper_silhouette(data2 = dag2, distance = dag.dist, add = "all observations")
siaf <- wraper_silhouette(data2 = daf2, distance = daf.dist, add = "all observations")
sils <- wraper_silhouette(data2 = lis2, distance = lis.dist, add = "least impacted")
silg <- wraper_silhouette(data2 = lig2, distance = lig.dist, add = "least impacted")
silf <- wraper_silhouette(data2 = lif2, distance = lif.dist, add = "least impacted")
sips <- wraper_silhouette(data2 = pus2, distance = pus.dist, add = "purified")
sipg <- wraper_silhouette(data2 = pug2, distance = pug.dist, add = "purified")
sipf <- wraper_silhouette(data2 = puf2, distance = puf.dist, add = "purified")

si_species <- rbindlist(list(sias, sils, sips))
si_genus   <- rbindlist(list(siag, silg, sipg))
si_family  <- rbindlist(list(siaf, silf, sipf))
```


```{r}
silhouette.plot1(x = si_species, taxon = "species")
silhouette.plot1(x = si_genus, taxon = "genus")
silhouette.plot1(x = si_family, taxon = "family")
```

# ANOSIM 
```{r COMPUTE ANOSIM}
anas <- wraper_anosim(grouping = das2, distance = das.dist, permutations = 99, add = "all observations")
anas <- wraper_anosim(grouping = das2, distance = das.dist, permutations = 99, add = "all observations")
anag <- wraper_anosim(grouping = dag2, distance = dag.dist, permutations = 99, add = "all observations")
anaf <- wraper_anosim(grouping = daf2, distance = daf.dist, permutations = 99, add = "all observations")
anls <- wraper_anosim(grouping = lis2, distance = lis.dist, permutations = 99, add = "least impacted")
anlg <- wraper_anosim(grouping = lig2, distance = lig.dist, permutations = 99, add = "least impacted")
anlf <- wraper_anosim(grouping = lif2, distance = lif.dist, permutations = 99, add = "least impacted")
anps <- wraper_anosim(grouping = pus2, distance = pus.dist, permutations = 99, add = "purified")
anpg <- wraper_anosim(grouping = pug2, distance = pug.dist, permutations = 99, add = "purified")
anpf <- wraper_anosim(grouping = puf2, distance = puf.dist, permutations = 99, add = "purified")

saveRDS(object = list(anas = anas,
                      anas = anas,
                      anag = anag,
                      anaf = anaf,
                      anls = anls,
                      anlg = anlg,
                      anlf = anlf,
                      anps = anps,
                      anpg = anpg,
                      anpf = anpf), 
       file = paste0("auxilliary/anosim_",data.set,".rds"))

an_species <- rbindlist(list(anas, anls, anps))
an_genus   <- rbindlist(list(anag, anlg, anpg))
an_family  <- rbindlist(list(anaf, anlf, anpf))

an_species_mean <- an_species[,mean(R), by = c("typology", "type")]
an_genus_mean   <- an_genus[,mean(R), by = c("typology", "type")]
an_family_mean  <- an_family[,mean(R), by = c("typology", "type")]
an_species_mean[,c("taxon.level", "variable") := .("species", "Anosim R")]
an_genus_mean[,c("taxon.level", "variable") := .("genus"  , "Anosim R")]
an_family_mean[,c("taxon.level", "variable") := .("family" , "Anosim R")]
```


```{r}
anosim.plot1(x = an_species, taxon = "species")
anosim.plot1(x = an_genus, taxon = "genus")
anosim.plot1(x = an_family, taxon = "family")
```

# Indicator and Typical taxa
```{r}
isas <- indicator_analysis(data3 = das3, data2 = das2, B.lvl = 0.33, add = "all observations")
isag <- indicator_analysis(data2 = dag2, data3 = dag3, B.lvl = 0.50, add = "all observations")
isaf <- indicator_analysis(data2 = daf2, data3 = daf3, B.lvl = 0.66, add = "all observations")
isls <- indicator_analysis(data2 = lis2, data3 = lis3, B.lvl = 0.33, add = "least impacted")
islg <- indicator_analysis(data2 = lig2, data3 = lig3, B.lvl = 0.50, add = "least impacted")
islf <- indicator_analysis(data2 = lif2, data3 = lif3, B.lvl = 0.66, add = "least impacted")
isps <- indicator_analysis(data2 = pus2, data3 = pus3, B.lvl = 0.33, add = "purified")
ispg <- indicator_analysis(data2 = pug2, data3 = pug3, B.lvl = 0.50, add = "purified")
ispf <- indicator_analysis(data2 = puf2, data3 = puf3, B.lvl = 0.66, add = "purified")

saveRDS(object = list(isas = isas,
                      isag = isag,
                      isaf = isaf,
                      isls = isls,
                      islg = islg,
                      islf = islf,
                      isps = isps,
                      ispg = ispg,
                      ispf = ispf), 
  file = paste0("auxilliary/indi_typ_",data.set,".rds"))


jac.spe <- rbindlist(list(jaccard_extract(isas),jaccard_extract(isls),jaccard_extract(isps)))
jac.gen <- rbindlist(list(jaccard_extract(isag),jaccard_extract(islg),jaccard_extract(ispg)))
jac.fam <- rbindlist(list(jaccard_extract(isaf),jaccard_extract(islf),jaccard_extract(ispf)))
mid.spe <- rbindlist(list(mid_extract(isas),mid_extract(isls),mid_extract(isps)))
mid.gen <- rbindlist(list(mid_extract(isag),mid_extract(islg),mid_extract(ispg)))
mid.fam <- rbindlist(list(mid_extract(isaf),mid_extract(islf),mid_extract(ispf)))
```


```{r}
jaccard_plot(jac.spe, "species")
jaccard_plot(jac.gen, "genus")
jaccard_plot(jac.fam, "family")
mid_plot(mid.spe, "species")
mid_plot(mid.gen, "genus")
mid_plot(mid.fam, "family")
```

```{r}
summary.out <- rbindlist(
        list(
                an_species_mean,
                an_genus_mean,
                an_family_mean,
                an_species_mean,
                an_genus_mean,
                an_family_mean,
                ivs_species_mean,
                ivs_genus_mean,
                ivs_family_mean,
                ivs_species_mean,
                ivs_genus_mean,
                ivs_family_mean,
                cs_species_mean,
                cs_genus_mean,
                cs_family_mean,
                cs_species_mean,
                cs_genus_mean,
                cs_family_mean
        )
)
fwrite(summary.out, file = paste0(data.set, ".csv"))
```


