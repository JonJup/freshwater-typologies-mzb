---
title: "Analyze traits from typical assemblages"
output: html_notebook
---

---
title: "Analyze traits from typical assemblages"
output: html_notebook
---

```{r}
knitr::opts_knit$set(root.dir = here::here())
# setup -----------------------------------------------
source("setup.R")
# load data -------------------------------------------
data = readRDS("../data/17_typical_assemblages_w_traits.rds")
```

Create a separate version of data, which only holds each taxon once. 
```{r}
traits = copy(data) 
traits %<>% 
        .[, c("genus_from_species", "rt") := NULL] %>% 
        unique(by="taxon") %>% 
        data.frame() %>% 
        column_to_rownames("taxon")  
```

Create another version of data which indicates whether any taxon belongs to the typical assemblages of a given river type. 
```{r}
data2 <-
        data.table(species = data$taxon,
                   site    = data$rt,
                   value   = 1) %>%
        pivot_wider(id_cols = site,
                    names_from = species,
                    values_from = value) %>% 
        dplyr::select(!"site") %>% 
        setnafill(fill = 0) %>% 
        as.matrix()
```

# Functional diversity 
```{r}
#gd = gowdis(traits)
fc = functcomp(traits, data2)
#db = dbFD(x = gd, a = data2, corr = "cailliez") 
```

# Ordination  

Doesn't work because there are NAs in the trait matrix and hence in the gower distance matrix.

```{r}
#nmds_obj = metaMDS(gd, try=1000)
```

```{r}
#pcoa_obj = ape::pcoa(gd)
```


# Functional composition plots 

`add_rt` holds the different stream types and `fc2`   
```{r}
add_rt = paste0(
        c("RT"),
        c("1", "2", "3","4_5", "9", "8_10_11_18", "14_15_16"))

fc2 <-
        fc %>%
        # convert each column to numeric
        map_df(.f = ~ as.numeric(.x)) %>%
        # add river type 
        mutate(rt = factor(add_rt)) %>%
        # one column with trait modalities and on with values 
        pivot_longer(col = !rt) %>%
        # separate trait and modality into separate columns
        mutate(trait = str_remove(name, "_.*"),
               modality = str_remove(name, ".*_")) %>% 
        # remove development trait 
        filter(trait != "dev") %>% 
        # remove RT from river types
        mutate(rt = str_remove_all(rt, "RT")) %>% 
        # adjust values so that all modalities add up to one for each trait
        group_by(trait, rt) %>% 
        mutate(total = sum(value)) %>% 
        mutate(adj_fctr = 1/total) %>% 
        mutate(value = value * adj_fctr)
fc2$rt = factor(fc2$rt, levels = c("1","2","3","4_5","9","8_10_11_18","14_15_16"))
fc2 %<>% 
        mutate(trait = replace(trait, trait == "feed", "feeding mode")) %>% 
        mutate(trait = replace(trait, trait == "volt", "voltinism")) %>% 
        mutate(trait = replace(trait, trait == "ovip", "oviposition")) %>% 
        mutate(trait = replace(trait, trait == "resp", "respiration")) %>% 
        mutate(trait = replace(trait, trait == "bf", "body form")) %>% 
        mutate(trait = replace(trait, trait == "locom", "locomotion")) %>% 
        mutate(modality = replace(modality, modality == "gil", "gills")) %>% 
        mutate(modality = replace(modality, modality == "teg", "tegument")) %>% 
        mutate(modality = replace(modality, modality == "spi", "spiracles")) %>% 
        mutate(modality = replace(modality, modality == "aqu", "aquatic")) %>% 
        mutate(modality = replace(modality, modality == "ovo", "ovovivipary")) %>% 
        mutate(modality = replace(modality, modality == "ter", "terrestrial"))
        
```

Define a ggplot function to display each trait separately. 

```{r}
pal = wes_palette("Zissou1", type = "continuous", n = 6)
pal = pal[c(1,4,3,2,5,6)]
fc2_plot = function(x){
       
        fc2 %>% 
                filter(trait == x) %>% 
                mutate(value = ifelse(value <= 0.01,NA,value))    %>%     
                ggplot(aes(x = rt, y = value, fill = modality)) +
                geom_col(position = "stack") + 
                geom_text(position = position_stack(vjust = 0.5), aes(label = round(value,2)), na.rm = T) + 
                #scale_fill_viridis_d(option = "viridis") + 
                #scale_fill_brewer(palette = "Dark2") + 
                scale_fill_manual(values = pal) + 
                theme(panel.grid.major = element_blank(), 
                      panel.grid.minor = element_blank(),
                      legend.position = "top", 
                      axis.text.y = element_blank(),
                      axis.title.y = element_blank(),
                      axis.ticks.y = element_blank(),
                      panel.background = element_blank()) + 
                guides(fill=guide_legend(title= x))
}
```

```{r}
map(.x = unique(fc2$trait),
     .f = fc2_plot)
```
