---
editor_options: 
  markdown: 
    wrap: sentence
---

# Supplementary Information

## Exclusion criteria 

In this section the exclusion criteria from Table 1 of the main text are described in more detail. 

**anthropogenic land use > 20% catchment area**. We used the Corine Land Cover data from 2018 to assign relative areas of land cover categories to each catchment in the Catchment Characteristics and Modelling data base of watersheds. 
On the first level there are five different categories in Corine Land Cover: 1. Artificial surfaces, 2. Agricultural areas, 3. Forest and semi natural areas, 4. Wetlands and 5. Water bodies. We combined the fractions of category 1 and 2 to obtain a measure of anthropogenic land use. If the relative catchment area of anthropogenic land use exceeded 20% all sites in that catchment were categorized as impaired. 

**IASPT** The Iberian average score per taxon was introduced by @alba1988metodo who developed the original metric proposed by @party1978final and @armitage1983performance. The score that the name refers to is the biological monitoring working party (BMWP) score. Many freshwater invertebrate families were assigned scores between 1 (indicator of strongly impaired conditions) and 10 (indicator of least-impaired conditions). For example, Oligochaetes have a low score and  Heptageniidae, a caddisfly family, a high score. The BMWP is the sum of scores for all taxa that occur at a site. Since the absolute score depends on the number of taxa, general thresholds for good or bad conditions can not be derived. This problem is solved by taking the average score of a sites (ASPT). Scores above 4.5 are generally taken to indicate good conditions.  

**BDI** The Biological Diatom Index was proposed by @lenoir1996development and is a standardized method used in France to monitor the biological quality of running waters. The original score was based on 209 diatom taxa and their ecological profiles. These profiles are probability distributions over the occurrence of a given species in the seven quality classes. By multiplying the presence probabilities for all taxa at a site one can derive the quality class which a site belongs to. The score is then mapped on a scale from 0 to 20 where 20 represents the highest ecological quality. @Coste2009 further improved the index by extending the taxon pool to 838 species and updating the ecological profiles of the available taxa. Scores above 14.5 are generally taken to indacte good conditions.  

**original site selection**. Two of the data sets we used resulted from studies that only took samples from least-impacted sites. We did not exclude any sites from these sites on the basis of anthropogenic impairment. 

**classification in data set** The STARS data set provided a qualitative rating of ecological conditions that ranged from high over good, moderate and poor to bad. We rated sites with a  good or high rating as least-impaired. 

**qualitative ratings of multiple anthropogenic stressors**. 
The data from the RCS monitoring program provided qualitative rating of several anthropogenic stressors. They included organic matter, nitrogen compounds (except nitrates), nitrates (mg/l NO3), phosphorous compounds, suspended matter, organic pollutants, mineral micropollutants, pesticides, and polycyclic aromatic hydrocarbon. 
Each stressor received a rating as high, good, intermediate, poor or bad. 
We considered all sites where two or more variables were rated as intermediate or one received a rating of poor or bad as impaired. 

## Distribution of removed sampling sites 

```{r fig-map-removed, fig.cap = "Maps of removed sampling sites. The first map (too far) shows sites that were more than 500 meters removed from the closesed BRT river segement. The second map (imparied) shows sites that were categorized as impaired. The third map (before 2000) shows sites that were sampled before 2000. "}

readPNG("fig/map_sites_removed.png") %>% 
  grid.raster()
```

\newpage

## Flexible beta clustering

This section describes in greater detail how we computed the flexible beta clustering of the sampling sites.
We used flexible beta clustering as it has been shown to be robust to various potential problems like outliers or noisy data [@Milligan1989].
Flexible beta clustering has four parameters but it is common to only specify one, $\beta$, while the other three parameters are derived from it.
We employed the common parameterization of $(\alpha_1 = \alpha_2 = \alpha, \beta = (1-\alpha)/2, \gamma = 0)$ and used a beta of 0.25.
We cut the resulting dendograms at each split between 4 and 30 final nodes.
For each of the resulting clusterings we calculated the average silhouette width and the cluster membership entropy.
The average silhouette width is already explained in the main text as well as in the following section on cluster validity metrics. 
The cluster membership entropy measures how similar the number of observation within different groups is. 
Clusterings with only few clusters tend to produce high silhouette widths by singling out individual outliers. 
Such solutions have very low entropies. 
To correct this tendency, we looked for a solutions that had high scores for both entropy and silhouette width. 
While entropy increased monotonically with the number of clusters (Figure \@ref(fig:beta-clust-qual)) without obvious jumps or dips, the average silhouette width started very low (4 clusters) then increased to a stable higher level (6-8 clusters) and lastly decreased sharply in three steps.  

```{r beta-clust-qual, fig.cap = "Average silhouette width and entropy of flexible beta clustering of the macroinvertebrate data with cluster numbers between 4 and 30. The black dashed horizontal line highlights the number of clusters we chose.", fig.height=4}
sm_beta_eval <- readRDS("fig/sm_beta_plot.RDS")
sm_beta_eval %>% 
        filter(name %in% c("avg.silwidth","entropy")) %>% 
        ggplot(aes(x = cluster.number, 
                   y = value)) + 
        geom_line() + 
        geom_point() +
        facet_wrap(.~name, 
                   scales = "free", 
                   labeller = labeller(name = c("avg.silwidth"= "ASW", 
                               "entropy" = "Entropy")) ) + 
        xlab("Cluster Number") + 
  geom_vline(xintercept = 9, lty = 2)
```

\newpage

## Cluster validity metrics

### Average silhouette width

The silhouette width $s(i)$ is defined as follows:

1.  Compute $a_i$, the average dissimilarity between sample $i$ and all other samples from the same type
2.  Among all other clusters $C$, find the cluster than minimizes $d(i,C)$ the average distance of $i$ to all observations of $C$. This cluster is $b$; $b_i = \min_C(d(i,C))$.
3.  $s(i) = \dfrac{b_i-a_i}{max(a_i,b_i)}$
4. The average silhouette width is the arithmetic mean of all silhouette widhts. $ASW = \frac{1}{n}\Sigma_{i=1}^n s(i)$

@Lengyel2019 recently proposed a generalized version of the ASW.
The classic ASW employs the arithmetic average to compute $a_i$ and $b_i$, which assumes that spherical clusters are optimal.
Using a generalized mean instead, we can flexibly adjust our validity metric to put a stronger emphasis on compactness ($a_i$) or separation ($b_i$).
The generalized mean of degree $p$ ($M^p$) is computed as: $$ M^p (\mathbf{x}) = \bigg( \dfrac{1}{n} \Sigma_{i=1}^n x_i^p\bigg)^{1/p} $$ The generalized mean can take the value of common summary statistics such as the minimum ($p=-\infty$), the maximum ($p=\infty$) or the harmonic mean ($p=-1$).
For example, for $p=-\infty$ the silhouette width is the difference between the minimum distance of observation $i$ to any other observation from the same type and the minimum distance from that observation to any observation from the next closest type.
This perspective excludes outliers and values separation over compactness.
The weighting shifts towards compactness as we increase $p$.

### Calinski Harabasz Index 

The Calinski-Harabasz Index [CH, @calinski1974dendrite] is computed as $$CH = \dfrac{BGSS}{WGSS} \times \dfrac{n-k}{k-1}$$ where $BGSS$ is the squared sum of distances between group centroids and the overall centroid (between group sum-of-squares), $WGSS$ is sum of squares of distances between observations of one group (within group sum-of-squares), $k$ is the number of clusters. High values indicate that variation within types is smaller than between types. As the second term controls for the degrees of freedom, here determined by the number of clusters, it can be understood as an analog to the F-Statistic. The algorithm assumes Euclidean data but good performance with a similar metric was shown for binary data in the context of fMRI-scans [@Dimitriadou2004].

### Indicator Value Statistic 

The indicator value score (IVS) is based on the Indicator value (IndVal) proposed by @dufrene1997species.
The IndVal can be understood as the product of the two quantities $A$ and $B$. 
For our purposes, $A$ is the relative number of observations of taxon $i$ that are within type $j$. 
It was initially described as specificity [@dufrene1997species] but is better understood as concentration [@Podani2010] because it is independent of the total number of types. 
$B$ is the relative frequency with which species $i$ occurs in type $j$. 
The maximum score is assigned to a species that only occurs in one type ($A=1$) and occurs in all samples of that type ($B=1$). 
We used the group-equalized version of the IndVal which accounts for the fact that the number of samples differs between types. 
The statistical significance of the IndVal statistic was assessed with a permutation test that computes IndVal values for random permutations of sites and types and compares the observed IndVal against this empirical distribution. 
We determined statistical significance with 999 permutations and a significance level of 0.01. 
The IndVal score is the fraction of statitically significant taxa X type combinations. 
A score of 1 would indicate that every taxon tested is a statitically significant indicator for every type and a score of 0 that no taxon is an statistically significant indicator for any type. 

\newpage

### Analysed river types/ ecoregions

```{r tab-types}
data = readRDS("data/09_sxs_genus_typology_wo_bio.rds")
gloric_unique = data %>% pull("gloric") %>% unique %>% sort
brt12_unique  = data %>% pull("ls12") %>% unique %>% sort
brt12_unique = brt12_unique[c(1,4:11,2,3)]
brt20_unique  = data %>% pull("ls20") %>% unique %>% sort
brt20_unique = brt20_unique[c(1,9:13,2:8)]
illies_unique = data %>% pull("illies") %>% unique %>% sort
eea_unique    = data %>% pull("eea") %>% unique %>% sort

s1 = data.table(Typology = c("BRT12", "BRT20", "GloRiC", "Illies", "BGR"),
           Types    = c(
                   paste(brt12_unique, collapse = ",\ "),
                   paste(brt20_unique , collapse = ",\ "),
                   paste(gloric_unique, collapse = ",\ "),
                   paste(illies_unique, collapse = ",\ "),
                   paste(eea_unique, collapse = ",\ ")
                        )
           )
s1[1,2] = c("
            Very large rivers (RT1); 
            Lowland, calcareous or mixed, medium-large (RT2);
            Lowland, calcareous or mixed, very small-small (RT3);
            Lowland, siliceous incl. organic, medium-large (RT4);
            Lowland, siliceous incl. organic, medium-large (RT5);
            Mid-altitude, calcareous incl. organic, medium-large (RT6);
            Mid-altitude, calcareous or mixed, very small-small (RT7);
            Mid-altitude, siliceous incl. organic, medium-large (RT8);
            Mid-altitude, siliceous incl. organic, very small-small (RT9);
            Highland and glacial (RT10)
            ")


s1[2,2] = c("Very large rivers (RT1); Lowland, siliceous, medium-large (RT2); Lowland, siliceous, very small-small (RT3); Lowland, calcareous or mixed, medium-large (RT4); Lowland, calcareous or mixed, very small-small (RT5); Mid-altitude, siliceous, medium-large (RT8); Mid-altitude, siliceous, very small-small (RT9); Mid-altitude, calcareous or mixed, medium-large (RT10); Mid-altitude, calcareous or mixed, very small-small (RT11) Highland (all Europe), siliceous, incl. organic (humic) (RT14); Highland (all Europe), calcareous/mixed (RT15); Glacial rivers (all Europe) (RT16); Mediterranean, mid altitude, medium-large, perennial (RT18)")
s1 %>%
        kbl(
                format = "latex",
                longtable = FALSE,
                caption = "Types per typology that were analysed. We had insufficient data for the types that are not shown in this table.",
                escape = F,
                booktabs = TRUE
        ) %>%
        kable_styling(
                latex_options = c("hold_position",
                                  "repeat_header"),
                full_width = TRUE,
                font_size = 9
        ) %>%
        row_spec(0, bold = T) %>% 
        column_spec(column = 1, width = "2cm")

```

